---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StatusBadge from '../../components/StatusBadge.astro';
import EvidencePanel from '../../components/EvidencePanel.astro';
import MappingBlock from '../../components/MappingBlock.astro';
import { policyCards } from '../../utils/data';
import { CATEGORY_LABELS, LEVEL_LABELS } from '../../types';
import type { PolicyCard } from '../../types';

export function getStaticPaths() {
  return policyCards.map((card) => ({
    params: { card_id: card.card_id },
    props: { card },
  }));
}

interface Props {
  card: PolicyCard;
}

const { card } = Astro.props;

/* 核验日期：该卡片 evidence 最大值 */
let maxVerified = '';
for (const ev of card.evidence_list) {
  if (ev.verified_date > maxVerified) maxVerified = ev.verified_date;
}
---

<BaseLayout title={card.title}>
  {/* 页眉 */}
  <div class="mb-6 space-y-2">
    <div class="flex flex-wrap items-center gap-2">
      <StatusBadge status={card.status} />
      <span class="text-xs text-gray-500">核验日期：{maxVerified}</span>
      {card.valid_from && (
        <span class="text-xs text-gray-500">适用期：{card.valid_from} ~ {card.valid_to || '至今'}</span>
      )}
    </div>
    <h1 class="text-2xl font-bold">{card.title}</h1>
    <div class="flex flex-wrap gap-2 text-xs">
      <span class="px-2 py-0.5 rounded bg-blue-100 text-blue-800">{CATEGORY_LABELS[card.category]}</span>
      <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">{LEVEL_LABELS[card.level]}</span>
      <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">{card.region}</span>
      {card.tags.map((tag) => (
        <span class="px-2 py-0.5 rounded bg-purple-50 text-purple-700">{tag}</span>
      ))}
    </div>
  </div>

  <div class="space-y-8">
    {/* ── 第一层：你能获得什么 ── */}
    <section class="space-y-3">
      <h2 class="text-lg font-bold border-b pb-1">你能获得什么</h2>
      <p class="text-gray-800">{card.benefit_summary}</p>
      <dl class="grid sm:grid-cols-2 gap-2 text-sm">
        {card.benefit_money_min != null && card.benefit_money_max != null && (
          <div>
            <dt class="text-gray-500">金额范围</dt>
            <dd class="font-medium">{card.benefit_money_min}–{card.benefit_money_max} 元</dd>
          </div>
        )}
        {card.benefit_money_max != null && card.benefit_money_min == null && (
          <div>
            <dt class="text-gray-500">最高金额</dt>
            <dd class="font-medium">{card.benefit_money_max} 元</dd>
          </div>
        )}
        {card.benefit_frequency && (
          <div>
            <dt class="text-gray-500">发放频率</dt>
            <dd class="font-medium">{card.benefit_frequency}</dd>
          </div>
        )}
        <div>
          <dt class="text-gray-500">适用对象</dt>
          <dd class="font-medium">{card.eligible_text}</dd>
        </div>
        <div>
          <dt class="text-gray-500">是否需要困难认定</dt>
          <dd class="font-medium">
            {card.requires_financial_assessment === true
              ? '是'
              : card.requires_financial_assessment === false
                ? '否'
                : '未知'}
          </dd>
        </div>
      </dl>
      {card.stacking_rules && (
        <p class="text-sm text-gray-600">
          <span class="font-medium">叠加规则：</span>{card.stacking_rules}
        </p>
      )}
    </section>

    {/* ── 第二层：怎么申请 ── */}
    <section class="space-y-3">
      <h2 class="text-lg font-bold border-b pb-1">怎么申请</h2>
      <p class="text-sm text-gray-600">
        <span class="font-medium">申请窗口：</span>{card.application_window_text}
      </p>
      {card.application_steps.length > 0 && (
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-1">申请步骤</h3>
          <ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
            {card.application_steps.map((step) => (
              <li>{step}</li>
            ))}
          </ol>
        </div>
      )}
      {card.materials.length > 0 && (
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-1">所需材料</h3>
          <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
            {card.materials.map((m) => (
              <li>{m}</li>
            ))}
          </ul>
        </div>
      )}
      {card.apply_portals.length > 0 && (
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-1">申请入口</h3>
          <div class="flex flex-wrap gap-2">
            {card.apply_portals.map((portal) => (
              <a
                href={portal.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm px-3 py-1 border rounded bg-blue-50 text-blue-700 hover:bg-blue-100 transition"
              >
                {portal.name} &rarr;
              </a>
            ))}
          </div>
        </div>
      )}
      {card.processing_time && (
        <p class="text-sm text-gray-600">
          <span class="font-medium">办理周期：</span>{card.processing_time}
        </p>
      )}
      {card.contact && (
        <p class="text-sm text-gray-600">
          <span class="font-medium">咨询：</span>{card.contact}
        </p>
      )}
    </section>

    {/* ── 第三层：到同济如何对接 ── */}
    <MappingBlock card={card} />

    {/* ── 第四层：官方依据 ── */}
    <EvidencePanel evidenceList={card.evidence_list} />
  </div>

  {/* 返回导航 */}
  <div class="mt-8 pt-4 border-t flex flex-wrap gap-3 text-sm">
    <a href="/p/anhui" class="text-blue-700 hover:underline">&larr; 返回安徽专区</a>
    <a href="/policies" class="text-blue-700 hover:underline">政策项目库</a>
    <a href={`/feedback?card_id=${card.card_id}`} class="text-blue-700 hover:underline">反馈纠错</a>
  </div>
</BaseLayout>
